<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Zophop &mdash; Geocoding</title>
  <style type="text/css">
  
  </style>
  <!-- v=3.exp&signed_in=true-->
  <link rel="shortcut icon" href="pic/zophop.png" />
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
   <link rel="stylesheet" href="css/Notification.css">
   <link rel="stylesheet" href="css/styles1.css">
   <link rel="stylesheet" href="css/I_style.css">
   <!--<link rel="stylesheet" href="http://code.jquery.com/ui/1.11.2/themes/smoothness/jquery-ui.css">-->
  <script src="http://code.jquery.com/jquery-1.10.2.js"></script>  
  <!--<script src="http://code.jquery.com/ui/1.11.2/jquery-ui.js"></script>-->
  <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
  <!--<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>-->
  <script type="text/javascript" src="http://maps.google.com/maps/api/js?libraries=places&sensor=false"></script>
	 <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>  
  <script type="text/javascript" src="script/gmaps.js"></script>
  <script src="script/jquery.geocomplete.js"></script>
  <!--<script src="jquery-csv.js"></script>-->
  <!--<script type="text/javascript" src="stps.js">
  
  </script>v=3.exp&signed_in=true-->
  <link rel="stylesheet" href="http://twitter.github.com/bootstrap/1.3.0/bootstrap.min.css" />
  <link rel="stylesheet" href="css/examples.css" />
  <script type="text/javascript" src="script/funs.js">
  </script>
   <script type="text/javascript" src="script/server.js">
  </script>
   <script type="text/javascript" src="script/ae_city.js">
  </script>
  <script type="text/javascript">
  //http://development.zophop.com:8080/scheduler_v4/v4/delhi/stops
  </script>
  <script type="text/javascript"></script>
</head>
<body>

  <div id="container flex-init-setup flex-ppal-setup" style="width:100%">
	<div id="heading" style="background-color: #FFFFFF; border-radius:10px; height:49px; width:100%; padding:6px">
	<div style="display: inline-block;">
				<select id="city" class="btn btn-success" style='background-color:#689f38' contenteditable='true'>
				<!--<option value="None">None</option>				
				<option value="MUMBAI">MUMBAI</option>-->
				</select>		
				<select id="MOD" class='btn btn-success'>
				</select>
			</div>
			
  <div style="float:right">&nbsp&nbsp<img src="pic/zophop.png" style="height:30px; width:30px;" alt="">	<h4 class="text-info" style="display:inline;"><strong>opHop &mdash; Geocoding</strong></h4>
		
		</div>
		<select style="float:right" class="btn btn-success" onchange='city_opts(this.value)' id="create_city">
		<option value="None">City Options</option>		
		<option value="Add City">Add City</option>
		<option value="Edit City">Edit City</option>		
		</select>
		</div>
		<div class="container-fluid1" style="font-size:80%">
		<br>
	<div style="width:100%" class="row">
		<div class="spa" id="notes" style="width:25%; height:90%; float:left; padding-left: 1cm;">
		<div id="submitB" style='float:right'><button class='btn btn-info' onclick="SubmitServer()">Submit</button></div>		
		<ul class="nav nav-tabs">
			<li id="menuUP" class="active"><a href="#" onclick="menu1(1)">Upload</a></li>
			<li id="menuStp"><a href="#" onclick="menu1(2)">Stops</a></li>
			<li id="menuRts"><a href="#" onclick="menu1(3)">Routes</a></li>
		</ul>
		<div class="row">
			<div class="span11">
				<br>
				<div id = "menu" style="margin-left:14px">
					<form>
						<input class="btn btn-primary1" type="file" id="routefile" onchange="fileChange(event)">
					</form>
					<button onclick="getStops(MOD,1)" style="display:inline-block;">Get Stops</button>	
					&nbsp&nbsp&nbsp<input id="ex1" type="range" id="chanceSlider" class="btn btn-primary1" min="1" max="99" step="1" style="width:200px; display: inline-block" value='75' onchange="chg()"/>					
									
					&nbsp&nbsp&nbsp&nbsp<label type="text" name="chance" id="rangeVal" style='' class="tFld" value='75' >75</label>				
				</div>
				<br>
				<div id="submenu" style="">
					<!--<input type="text" name="chance" id="rangeVal" class="text" value="75" readonly style="width:30px">
					<input id="ex1" type="range" id="chanceSlider" class="vHorizon" min="1" max="99" step="1" style='width:300px' value='75' onchange="chg()"/>
					<div id="swapbts"></div>-->
				</div>
				<br>
				<div id="menu3"></div>
			</div>
		</div>
		
		<div id="tbl" align='left' style="max-height:60%; width:100%; float:left;">	
		</div>
	</div>
	<div class="spa" style="width:74%; float:right;">     
		<div class="row">
			<div class="input" id='map-search'>	
				<form method="post" id="geocoding_form">
					<input type="text" id="address" name="address" />
				</form>
			</div>
		</div>     
    <div  id="map" style="height:100vh"></div>     
  </div>
  </div>
	</div> 
	</div>
    <div class="chat-box">
    <input type="checkbox" />
    <div class='label1' data-expanded="Close Notifications" data-collapsed="Notifications"></div>
	    <div id="NOC_Mess_sh">No Messages<hr></div>
    <div class="chat-box-content">
			<div id="Noc_List" style="max-height:300px; overflow:auto"></div>        
        </div>
        </div>
        <div id="alert_box" class=""></div>
<div id='black_over' class="black_overlay">

</div>
<div id="light" class="white_content">
<div class="row">

<a href = "##" onclick = "closepw()" class="textright" style="float:right"><img src="pic/close.png" style='height:30px; width:30px;' alt="Close"></a>
<!--<p style="display: inline-block; float:right;">&nbsp;&nbsp;</p>
<button style="float:right;">Get Bounds</button>-->
</div>
<div id="picmax" style="float:left; height:100% width:30%">
	<div id="city_heading" style="max-width:100%"></div>
	<div id="city_data" style="height:80%; max-width:100%;"></div>
</div>
<div id='map1' style='height:100%; width:66%; float:right;'></div>
</div>
<script>
function NOC_Show_messege(d) {
	var de = document.getElementById("NOC_Mess_sh");	
	if (d==1) {
		de.setAttribute("align", "left");		
		de.innerHTML = "<input type='checkbox' id='totalChk' onchange='changeCheckBox(this)'/>Select all<button class='s_btn1' onclick='removeCheckedNotification(1)'>YES</button>&nbsp<button class='s_btn1' onclick='removeCheckedNotification(0)'>NO</button><hr>";	
	}
	else {
	de.setAttribute("align", "center");		
		de.innerHTML = "No Messages<hr>";	
	}
		
}
var create_city = 0;
function city_opts(val) {
	if (val!='None') {
	add_city();
	var pic = document.getElementById('city_data');
	if (val=='Add City') {
	AC_add_city();
		//pic.innerHTML =C_add_city();
	}
	else {
	var pi = document.getElementById('city_heading');
		pi.innerHTML = edit_city();
		/*pic.innerHTML +=C_add_city();
		pic.innerHTML +=A_edit_additional(); */
	}	
	loadMap1();		
	}		
}
function closepw() {
	document.getElementById('light').style.display='none';document.getElementById('black_over').style.display='none';
	document.body.style.overflow='scroll';
	city_clean();
	clean();
}
function submitCheck() {
	if (wp.length!=0&&wp.length<=fpk.length) {			
			RouteDone();			
			routeSubmit();
			//clean();
		}
}
function SubmitServer() {
	if (Fstate!=0) {
	if (P_state==1) {
				console.log("Submit server 1 :"+SRoute);
				wp =[];				
				fpk = [];
				//flightPathClean();
				//DirectionServices();
				//time = setInterval(submitCheck,1000);
				//GTDirect();
				routeSubmit();
				//clean();
				$("#routefile").val("");				
		}
	else if(P_state==2)
	{
			submitStop(the_Stop);
			clean();
	}
	else if (P_state==3) {
			console.log("Submit server 1 :"+SRoute);
				wp =[];				
				fpk = [];
				routeSubmit();				
				//flightPathClean();
				//DirectionServices();
				//time = setInterval(submitCheck,1000);
				//GTDirect();
				$("#routeField").val("");
	}
	//clean();
	}
}
$( "#city" ).change(function() {
	clean();
  var city1 = $("#city").val();
  if (city1=='None') {
  	city = 'None';
  }
  else {
	city = city1;  	
  	getModes(city);	
  } 
});
function add_city() {
	var de = document.getElementById('black_over');
   var wt = document.getElementById('light');  
	document.body.style.overflow = "hidden"; 
  	de.style.display='block';
 	wt.style.display='block';
 	var str = '<div id=a_city>';
 	str+='</div>'; 	
 	//load_overServer();
}
$( "#MOD" ).change(function() {
	clean();	
	MOD	= $("#MOD").val();
	getStops(MOD,0); 
});
	function stpkeyprees(e,ind) {
			//alert("sdfs1");
	if(e.which == 10 || e.which == 13) {
			if (ind==0) {
				callServerGetStop();
			}
			else if(ind==1){
				callServerRoute();
			}         
            }
}; 
function menu1(opt) {
	clean();
	mrk = map.markers;	
	for (i=0;i<mrk.length;i++) {
		console.log("in menu");		
		mrk.setMap(null);	
	}	
	P_state = opt;
	console.log("P state :"+P_state);
	Fstate = 0;
	 map.map.setZoom(10);
		if (opt==1) {
			$("#menuUP").attr("class","active");
			$("#menuStp").attr("class","active1");			
			$("#menuRts").attr("class","active1");
			var str = "<form><input class='btn btn-primary1' type='file' id='routefile' onchange='fileChange(event)'></form>";			
				str+='<button onclick="getStops(MOD,1)">Get Stops</button>';				
			str+='&nbsp&nbsp&nbsp<input id="ex1" type="range" id="chanceSlider" class="btn btn-primary" min="1" max="99" step="1" style="width:200px; display: inline-block" value='+radius+' onchange="chg()"/>';						
			str+='&nbsp&nbsp&nbsp&nbsp<input type="text" name="chance" id="rangeVal" style="" class="tFld" value='+radius+' readonly>';			
			$("#menu").html(str);
		//	$("#typ").html("New Route");		
			
		}
		else if (opt==2) {
			$("#menuUP").attr("class","active1");
			$("#menuStp").attr("class","active");			
			$("#menuRts").attr("class","active1");			
			$("#menu").html("<input class='form-group' type='text' id='stopField' list='stopsList' onkeypress='stpkeyprees(event,0)' onkeyup='getStopsList(this.value)' placeholder='Enter Stop Name'><datalist id='stopsList' onchange='oc()'></datalist>");//<datalist id='stopsList'></datalist>
		//	$("#typ").html("Search Stops");
			}
		else if(opt==3){
			$("#menuUP").attr("class","active1");			
			$("#menuStp").attr("class","active1");
			$("#menuRts").attr("class","active");
			var str = "<input class='' type='text' id='routeField' list='routesList' onkeypress='stpkeyprees(event,1)' onkeyup='getRouteList(this.value)'><datalist id='routesList'></datalist>";	//callServerRoute()		
			str+='&nbsp&nbsp&nbsp<input id="ex1" type="range" id="chanceSlider" class="btn btn-primary" min="1" max="99" step="1" style="width:200px; display: inline-block" value='+radius+' onchange="chg()"/>';					
			str+='&nbsp&nbsp&nbsp&nbsp<input type="text" name="chance" id="rangeVal" style="" class="tFld" value='+radius+' readonly>';			
			$("#menu").html(str);
		//	$("#typ").html("Search Routes");		
		//	P_state = 3;		
		}
		$("#submenu").html("");
	}
	function callServerRoute() {
		 var v = $("#routeField").val();		 
		console.log("calling route");		 
		 getRoute(v);
	} 
	function autoStop(str) {
		var arr = getStopsList(str);
		console.log("len:"+arr.length);
		$( "#stopField" ).autocomplete({
      source: arr
    });
	} 
//class created for 
function city_stop(s_name,lat,lan,s_id,tran_t,station_t,stop_c,alias,state) {
	this.mrk = mark;
	this.mrk(lat,lan,title);
	delete this.mrk;	
	this.stop_id;
	this.transport_type;
	this.station_type;
	this.stop_code;
	this.alias;
	if (state==NaN) {
		this.state=state;
	}
	else {
		this.state=0;	
	}
}
function trie() {
	ds = [];
	state=-1;
	index=-1;
	
}
	function chg() {
	$("#rangeVal").html($("#ex1").val());
	//$("#Noc_List").html("");
	radius = parseInt($("#ex1").val());	
	setBounds(parseInt($("#ex1").val()));
   
}
function check_first(cs) {
	checkroute(routeNM,cs[1].stop_name);
		for (i=1;i<cs.length;i++) {
			if (cs[i].lat!=null&&cs[i].lon!=null) {
				map.setCenter(cs[i].lat, cs[i].lon);			
			}
		}
	//var firstData = check_first(csvval);//csvval[1].split(",");	
//	map.setCenter(parseFloat(firstData[1]), parseFloat(firstData[2]));
}
function loadLST(e) {
	var csvval=e.split("\n");
	var line1 = csvval[0];
	line1 = line1.trim(); 	
	if (line1!='StopName,Lat,Lon'&&line1.split(',')[0]!='StopName'&&line1.split(',')[0]!='stopname') {
		csvval.splice(0,0,'first');
	}
	var len = csvval.length;	
	if(csvval[csvval.length-1]=="")
	{
		len-=1;	
	}
	var f_cnt = 0;
	for(var i=1;i<len;i++)
	{
	var stopData=csvval[i].split(",");
	var lat1 = parseFloat(stopData[1]);
	var log1 = parseFloat(stopData[2]);
	var state = 1;
	var nam = stopData[0];
	if (isNaN(lat1) ||isNaN(log1)) {
			state = 2;
			codeAddress(stopData[0]+","+city.city+",India",i);		
			console.log(stopData[0]+","+city.city+",India");	
			lat1 = null;
			log1 = null;
			f_cnt++;		
		}
	lst[i] = new mark(lat1,log1,nam,state);
	}
	if (f_cnt>lst.length/2) {
		file_fault = true;	
	}	
	check_first(lst);
}
var routeNM;
function fileChange(e) {
	//MOD = "BUS";
	//city = 'MUMBAI';
	if (city=="None"||MOD=="None") {
		alert("First select City and Mode of transport Mr Smart");
		$("#routefile").val(null);
				
		return;	
	}
	var ext = $("input#routefile").val().split(".").pop().toLowerCase();	
	if($.inArray(ext, ["txt"]) == -1&&$.inArray(ext, ["csv"]) == -1) {
	alert('Upload CSV');
	return false;
	}
	    
	if (e.target.files != undefined) {
	console.log("data target :"+e.target.files[0].name+" : "+city.city);
	routeNM = e.target.files[0].name.split(".")[0];
	//alert("fn"+routeNM);
	lst=[];	
	//map.removeMarkers();			
	var reader = new FileReader();
	reader.onload = function(e) {
	var csvval=e.target.result.split("\n");	
	//var firstData = csvval[1].split(",");
	if (Fstate==0) {
		//map.zoomIn(6);
		map.map.setZoom(6);
		Fstate=1;	
	}
	else {
	console.log("cleaning");
		clean();		
		//map.removeMarkers();		
	}
	loadLST(e.target.result);
	SRoute= new route(null,routeNM,lst[1].stop_name,lst[lst.length-1].stop_name,city.city);
	//loadSubmenu(1);
	loadMenu3();
	checkChange();
	load();
	change();
	evts();
	//DirectionServices();
//	getDirections();
	};
	reader.readAsText(e.target.files.item(0));
	}
	return false;
}
var geocoder = new google.maps.Geocoder();
function codeAddress(address,ind) 
{
  geocoder.geocode( {address:address}, function(results, status) 
  {
    if (status == google.maps.GeocoderStatus.OK) 
    {
      //place a marker at the location
		//alert("location of :"+ind);		
		var ind1=-1;
		var d = Number.MAX_VALUE;
	for (i=0;i<results.length;i++) {
		
	    console.log("location :"+results[i].geometry.location.lng());
	    //console.log(center);
	    //console.log(center.lat()+":"+center.lng()+":"+results[i].geometry.location.lat()+","+results[i].geometry.location.lng());  
		var dist = getDistance(center.lat(),center.lng(),results[i].geometry.location.lat(),results[i].geometry.location.lng());		
		console.log(dist+" "+d);
		if(dist<d)
		{
			d=dist;
			ind1=i;
		}      
    }
    if (lst[ind].state==2&&ind1!=-1) {
		console.log("location is found");
			lst[ind].lat=results[ind1].geometry.location.lat();
			lst[ind].lon=results[ind1].geometry.location.lng();
			lst[ind].state=1;
			addMarker(ind);
			dragEvent(lst1[ind]);
			setTable();
			change();
			//$("#Noc_List").html("<div id='geo' >Marker No :"+ind+" added to map<hr></div>"+$("#Noc_List").html());
			check_NotificationBar();
		}
    } else {
      console.log('Geocode was not successful for the following reason: ' + status);
   }
  });
}
function addSimpleMarker() {
	lti = lat;
	lng = log;
	var myLatlng = new google.maps.LatLng(lti,lng);
	
	var marker = new google.maps.Marker({
    position: myLatlng,
    map: map.map,
    title:"new area",
	 icon:"http://www.iarp.it/img/icon-gmaps.png",					
});
mrk = marker;
var infowindow = new google.maps.InfoWindow({
      content: "<div id='newData' size='height:40 width:80' >Sequence No:<input type='text' id='new_seq'/>Description: <input type='text' id='new_desc'/> <button onclick='create(mrk,lti,lng)'>Click Me!</button></div>"
  });
google.maps.event.addListener(marker, 'click', function() {
    infowindow.open(map.map,marker);
  });
}
$("#address").keypress(function (e) {
	if(e.which == 10 || e.which == 13) {
                $("#geocoding_form").submit();
            }
}); 
function callServerGetStop() {
	var val = $("#stopField").val();
	if (val!=NaN&&val!="") {
		getStop(val);
	}	
}
function check_NotificationBar() {
		var dc = document.getElementById("Noc_List").childNodes;
		var there = false;
		var de = document.getElementById('NOC_Mess_sh');		
		if (dc.length==0) {
				de.setAttribute("align", "center");
				de.innerHTML = "NO Messages<hr>";		
			return;
		}		
			for (i=0;i<dc.length;i++) {
				if (dc[i].id.match('note*')) {
						NOC_Show_messege(1);
						return;
				}
		}
			de.setAttribute("align", "center");		
			de.innerHTML = "NO Important Messages<hr>";
			return;		
}
</script>
</body>
</html>
